server {
    listen 80;
    server_name localhost;
    root /usr/share/nginx/html;
    index index.html;

    # Under Construction Mode
    # To bypass: visit any page with ?access=gpr2025 (sets cookie for 30 days)
    # To disable: set $maintenance_mode 0; below
    # Whitelisted paths: /blog/, /seo-lab/ (always accessible)
    set $maintenance_mode 1;

    # Check for bypass cookie
    if ($cookie_gpr_access = "authorized") {
        set $maintenance_mode 0;
    }

    # Check for access parameter to set cookie
    if ($arg_access = "gpr2025") {
        set $maintenance_mode 0;
    }

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied expired no-cache no-store private auth;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml application/javascript application/json;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Under construction page handler
    location @under_construction {
        root /usr/share/nginx/html;
        try_files /under-construction.html =503;
    }

    # Set access cookie endpoint
    location = /set-access {
        if ($arg_access = "gpr2025") {
            add_header Set-Cookie "gpr_access=authorized; Path=/; Max-Age=2592000; HttpOnly; SameSite=Strict";
            return 302 /;
        }
        return 403;
    }

    # Seller Portal React App - must come before Hugo catch-all
    location /seller-portal/ {
        if ($maintenance_mode = 1) {
            return 302 /under-construction.html;
        }
        alias /usr/share/nginx/html/seller-portal/;
        try_files $uri $uri/ /seller-portal/index.html;
    }

    # Buyer Search React App
    location /buyer-search/ {
        if ($maintenance_mode = 1) {
            return 302 /under-construction.html;
        }
        alias /usr/share/nginx/html/buyer-search/;
        try_files $uri $uri/ /buyer-search/index.html;
    }

    # Buyer Search API proxy - routes to buyer-search-api container
    location /buyer-api/ {
        proxy_pass http://gpr-buyer-api:4000/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # SEO Lab React App (whitelisted - has its own Supabase auth)
    location /seo-lab/ {
        alias /usr/share/nginx/html/seo-lab/;
        try_files $uri $uri/ /seo-lab/index.html;
    }

    # SEO Lab API proxy - routes to gpr-seo-api container
    location /seo-api/ {
        proxy_pass http://gpr-seo-api:8001/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # AVM API proxy - routes to gpr-avm-api container
    location /api/ {
        proxy_pass http://gpr-avm-api:8000/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # PDF Service proxy - routes to gpr-pdf-service container
    location /pdf-api/ {
        proxy_pass http://gpr-pdf-service:3003/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 60s;  # PDF generation can take time
    }

    # Under construction page - always accessible
    location = /under-construction.html {
        # Set cookie if access parameter is provided
        if ($arg_access = "gpr2025") {
            add_header Set-Cookie "gpr_access=authorized; Path=/; Max-Age=2592000; SameSite=Strict";
            return 302 /;
        }
        try_files /under-construction.html =404;
    }

    # Blog posts (whitelisted - for SEO Lab "View Live" functionality)
    # Try live-deployed content first, then fallback to built-in
    location /blog/ {
        # First try runtime-deployed blog content, then fallback to original build
        try_files /blog-live/blog/$uri /blog-live/blog/$uri/ /blog-live/blog/$uri/index.html $uri $uri/ $uri.html =404;
    }

    # Hugo static site - catch all
    location / {
        if ($maintenance_mode = 1) {
            return 302 /under-construction.html;
        }
        try_files $uri $uri/ $uri.html /index.html;
    }

    # Cache static assets
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Health check endpoint - always accessible (for Docker health checks)
    location /health {
        access_log off;
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }
}
